-- ğŸ§  Ø§Ù„Ø®Ø¯Ù…Ø§Øª
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local UserInputService = game:GetService("UserInputService")
local VirtualUser = game:GetService("VirtualUser")

local localPlayer = Players.LocalPlayer
local camera = Workspace.CurrentCamera

-- ğŸ¯ Ø¯Ø§Ø¦Ø±Ø© FOV
local FOVring
if getgenv().settings.drawFov then
    FOVring = Drawing.new("Circle")
    FOVring.Thickness = 2
    FOVring.Filled = false
    FOVring.Color = Color3.fromRGB(255, 0, 0)
    FOVring.Visible = true
end

-- ğŸ”’ Ø­Ù…Ø§ÙŠØ© Ù…Ù† Ø§Ù„ÙƒØ´Ù
local lastProtectionCheck = tick()
local protectionInterval = math.random(5, 10)
local function performProtection()
    if not getgenv().settings.enable_protection then return end
    if tick() - lastProtectionCheck >= protectionInterval then
        lastProtectionCheck = tick()
        protectionInterval = math.random(5, 10)
        if false then
            warn("âš ï¸ Ù†Ø´Ø§Ø· Ù…Ø´Ø¨ÙˆÙ‡ - ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø£ÙŠÙ…Ø¨ÙˆØª")
            getgenv().settings.enable_aimbot = false
        end
    end
end

-- âœ… ÙØ­Øµ Ø§Ù„ÙØ±ÙŠÙ‚
local function isEnemy(player)
    if not getgenv().settings.teamCheck then return true end
    return player.Team == nil or localPlayer.Team == nil or player.Team ~= localPlayer.Team
end

-- âœ… ÙØ­Øµ Ø¥Ø°Ø§ Ø­ÙŠ
local function isAlive(player)
    return player.Character and player.Character:FindFirstChild("Humanoid") and player.Character.Humanoid.Health > 0
end

-- ğŸ‘€ ÙØ­Øµ Ø§Ù„Ø±Ø¤ÙŠØ© (ØªØ¨Ø¹ Ø§Ù„Ø¬Ø¯Ø±Ø§Ù†)
local function isPartVisible(part)
    if not getgenv().settings.wallCheck then return true end
    local origin = camera.CFrame.Position
    local direction = (part.Position - origin).Unit
    local distance = (part.Position - origin).Magnitude

    local raycastParams = RaycastParams.new()
    raycastParams.FilterDescendantsInstances = {localPlayer.Character, part.Parent}
    raycastParams.FilterType = Enum.RaycastFilterType.Blacklist
    raycastParams.IgnoreWater = true

    local result = Workspace:Raycast(origin, direction * distance, raycastParams)
    return not result
end

-- ğŸ” Ù‡Ù„ Ø§Ù„Ù‡Ø¯Ù Ø¶Ù…Ù† FOVØŸ
local function isWithinFov(targetPosition)
    local camPos = camera.CFrame.Position
    local camLook = camera.CFrame.LookVector
    local toTarget = (targetPosition - camPos).Unit

    local dot = camLook:Dot(toTarget)
    local angle = math.deg(math.acos(dot))

    return angle <= (getgenv().settings.fov or 30)
end

-- ğŸ§  Ø¥ÙŠØ¬Ø§Ø¯ Ø£Ù‚Ø±Ø¨ Ø¹Ø¯Ùˆ Ù…Ø±Ø¦ÙŠ
local function getClosestEnemy()
    local closest = nil
    local shortest = math.huge

    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= localPlayer and isEnemy(player) and isAlive(player) then
            local head = player.Character:FindFirstChild("Head")
            if head and isPartVisible(head) and isWithinFov(head.Position) then
                local dist = (head.Position - localPlayer.Character.HumanoidRootPart.Position).Magnitude
                if dist < shortest then
                    shortest = dist
                    closest = head
                end
            end
        end
    end

    return closest, shortest
end

-- ğŸ”® Ø§Ù„ØªÙ†Ø¨Ø¤ Ø¨Ø§Ù„Ø­Ø±ÙƒØ©
local function predict(hitbox)
    if not getgenv().settings.enable_prediction then
        return hitbox.Position
    end
    return hitbox.Position + (hitbox.Velocity * getgenv().settings.predictionFactor)
end

-- ğŸ”« Ø¶Ø±Ø¨Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©
local function fire()
    VirtualUser:Button1Down(Vector2.new(), camera.CFrame)
    task.wait()
    VirtualUser:Button1Up(Vector2.new(), camera.CFrame)
end

-- â™»ï¸ Ø­Ù„Ù‚Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
RunService.RenderStepped:Connect(function()
    performProtection()

    -- âšª ØªØ­Ø¯ÙŠØ« Ø¯Ø§Ø¦Ø±Ø© FOV
    if FOVring then
        FOVring.Position = camera.ViewportSize / 2
        FOVring.Radius = math.clamp((getgenv().settings.fov or 30) * 4, 10, 1000)
        FOVring.Visible = getgenv().settings.enable_aimbot and getgenv().settings.drawFov
    end

    -- ğŸ§  ØªÙ†ÙÙŠØ° Ø§Ù„ØªØµÙˆÙŠØ¨
    if not getgenv().settings.enable_aimbot then return end

    local target, distance = getClosestEnemy()
    if target then
        local pos = predict(target)
        local from = camera.CFrame.Position
        local smooth = math.clamp(1 / distance, 0.1, 0.5)

        camera.CFrame = CFrame.new(from, pos):Lerp(CFrame.new(from, pos), smooth)

        if getgenv().settings.enable_autoattack then
            fire()
        end
    end
end)

-- âŒ Ø­Ø°Ù Ø¯Ø§Ø¦Ø±Ø© FOV Ø¨Ø²Ø± Delete
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    if input.KeyCode == Enum.KeyCode.Delete and FOVring then
        FOVring:Remove()
        FOVring = nil
    end
end)
